# Function calling

了解如何將大型語言模型連接到外部工具。

## 介紹

在 API 呼叫中，您可以描述函數，並讓模型智慧地選擇輸出包含呼叫一個或多個函數的參數的 JSON 物件。Chat Completions API 不會呼叫該函數；相反，模型會產生 JSON，您可以使用它來呼叫程式碼中的函數。

最新模型（`gpt-3.5-turbo-1106` 和 `gpt-4-1106-preview`）經過訓練，可以檢測何時應調用函數（取決於輸入）並使用遵循函數簽名的 JSON 進行響應比以前的型號更接近。這種能力也帶來了潛在的風險。我們強烈建議在代表用戶採取行動（發送電子郵件、在線上發佈內容、購買等）之前建立用戶確認流程。

## 常見用例

函數呼叫可讓您更可靠地從模型中取得結構化資料。例如，您可以：

- 建立透過呼叫外部 API 來回答問題的助手（例如 ChatGPT 插件）
    - 例如定義諸如 `send_email(to: string, body: string)` 或 `get_current_weather(location: string, unit: 'celsius' | 'fahrenheit')` 之類的函數
- 將自然語言轉換為 API 呼叫
    - 例如轉換 "誰是我的主要客戶？" `get_customers(min_revenue: int, created_before: string, limit: int)` 並且呼叫您的內部 API
- 從文字中提取結構化數據
    - 例如定義一個名為 `extract_data(name: string,birthday: string)` 或 `sql_query(query: string)` 的函數

函數呼叫的基本步驟順序如下：

1. 使用使用者查詢和函數參數中定義的一組函數來呼叫模型。
2. 模型可以選擇呼叫一個或多個函數；如果是這樣，內容將是一個符合您的自訂架構的字串化 JSON 物件（注意：模型可能會產生參數）。
3. 在程式碼中將字串解析為 JSON，並使用提供的參數（如果存在）呼叫函數。
4. 透過將函數回應作為新訊息附加來再次呼叫模型，並讓模型將結果匯總傳回給使用者。

## 支援模型

並非所有模型版本都使用函數呼叫資料進行訓練。以下模型支援函數呼叫：

- gpt-4
- gpt-4-1106-preview
- gpt-4-0613
- gpt-3.5-turbo
- gpt-3.5-turbo-1106
- gpt-3.5-turbo-0613

此外，以下模型支援併行函數呼叫：

- gpt-4-1106-preview
- gpt-3.5-turbo-1106

## 併行函數調用

併行函數呼叫是模型同時執行多個函數呼叫的能力，允許並行解決這些函數呼叫的效果和結果。如果函數需要很長時間，這尤其有用，並且可以減少 API 的往返次數。例如，模型可能會呼叫函數來同時取得 3 個不同位置的天氣，這將導致在 `tool_calls` 陣列中產生一條包含 3 個函數呼叫的訊息，每個函數呼叫都有一個 id。

要回應這些函數調用，請在對話中新增 3 個新訊息，每個訊息都包含一個函數調用的結果，並使用 `tool_call_id` 引用 `tool_calls` 中的 `id`。

在此範例中，我們定義了一個函數 `get_current_weather`。模型多次呼叫函數，並將函數回應傳回模型後，我們讓它決定下一步。它回覆了一條面向用戶的訊息，告訴用戶舊金山、東京和巴黎的氣溫。根據查詢，它可能會選擇再次呼叫函數。

如果您想要強制模型呼叫特定函數，可以透過設定 `tool_choice` 與特定函數名稱來實現。您也可以透過設定 `tool_choice: "none"` 強制模型產生使用者導向的訊息。請注意，預設行為 `（tool_choice：“auto”）` 是模型自行決定是否呼叫函數以及如果呼叫哪個函數。

## 令牌

在底層，函數依照模型訓練過的語法注入到系統訊息中。這表示函數會根據模型的上下文限制進行計數，並作為輸入令牌進行計費。如果遇到上下文限制，我們建議限制函數的數量或為函數參數提供的文件的長度。

如果定義了許多函數，也可以使用微調來減少使用的標記數量。